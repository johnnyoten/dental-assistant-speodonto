# üì± Tutorial WhatsApp + Gemini - Cl√≠nica Speodonto

## O que vamos fazer

Conectar o WhatsApp Business com a IA Gemini para:

- ‚úÖ Receber mensagens dos clientes
- ‚úÖ IA responder automaticamente
- ‚úÖ Agendar consultas via conversa natural
- ‚úÖ Salvar agendamentos no banco
- ‚úÖ Enviar confirma√ß√£o

**Tudo 100% GR√ÅTIS!** üí∞

---

## üìã Pr√©-requisitos

- [ X ] Backend funcionando (tutorial 1)
- [ ] Deploy na Vercel feito
- [ X ] Gemini configurado e funcionando
- [ ] URL da Vercel anotada

---

## üöÄ Passo 1: Criar App no Meta (3 min)

### 1.1 Acessar Meta for Developers

üîó **https://developers.facebook.com/**

### 1.2 Criar Conta/Login

- Use sua conta Facebook/Instagram
- Aceite os termos

### 1.3 Criar Novo App

1. Clique em **"Meus Apps"** ou **"My Apps"**
2. Clique em **"Criar App"** ou **"Create App"**
3. Escolha: **"Business"** (Neg√≥cios)
4. Clique em **"Avan√ßar"**

### 1.4 Preencher Dados

```
Nome do App: Cl√≠nica Speodonto
(ou o nome do seu consult√≥rio)

Email: seu@email.com

Conta de Neg√≥cios: [Criar nova]
(se n√£o tiver)
```

5. Clique em **"Criar App"**
6. Complete verifica√ß√£o de seguran√ßa (se pedir)

‚úÖ App criado!

---

## üìû Passo 2: Adicionar WhatsApp (2 min)

### 2.1 Encontrar WhatsApp

Na p√°gina do app, procure o card **"WhatsApp"**

### 2.2 Configurar

Clique em **"Configurar"** ou **"Set Up"**

Aguarde carregar...

‚úÖ WhatsApp adicionado!

---

## üîë Passo 3: Copiar Credenciais (3 min)

Voc√™ est√° na p√°gina **"API Setup"**. Aqui tem tudo que precisa:

### 3.1 Copiar Access Token

Procure: **"Temporary access token"** ou **"Token de acesso tempor√°rio"**

```
EAAxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

1. Clique em **"Copy"**
2. Salve no Bloco de Notas

‚ö†Ô∏è **Importante:** Este token expira em 24h!

### 3.2 Copiar Phone Number ID

Procure: **"Phone number ID"**

```
123456789012345
```

1. Copie este n√∫mero (15 d√≠gitos)
2. Salve no Bloco de Notas

### 3.3 Escolher Verify Token

**Voc√™ escolhe!** Pode ser qualquer texto seguro:

```
meu_token_verificacao_123
```

1. Anote este token
2. **Use o mesmo depois no webhook!**

---

## üìù Passo 4: Configurar .env (1 min)

Edite o arquivo `.env`:

```env
# WhatsApp API
WHATSAPP_API_TOKEN="EAAxxxxxxxxx..."
WHATSAPP_PHONE_NUMBER_ID="123456789012345"
WHATSAPP_VERIFY_TOKEN="meu_token_verificacao_123"
```

Cole os 3 valores que voc√™ copiou/escolheu!

---

## üåê Passo 5: Atualizar Deploy (2 min)

### 5.1 Adicionar Vari√°veis na Vercel

```bash
vercel env add WHATSAPP_API_TOKEN
```

Cole o token EAAxxxx...

```bash
vercel env add WHATSAPP_PHONE_NUMBER_ID
```

Cole o phone ID

```bash
vercel env add WHATSAPP_VERIFY_TOKEN
```

Cole o verify token que voc√™ escolheu

### 5.2 Novo Deploy

```bash
vercel --prod
```

Aguarde...

‚úÖ Deploy atualizado com WhatsApp configurado!

---

## üîó Passo 6: Configurar Webhook (3 min)

### 6.1 Ir para Configuration

No painel do Meta, clique em **"Configuration"** (menu lateral esquerdo)

### 6.2 Configurar Webhook

Procure a se√ß√£o **"Webhook"**

Clique em **"Edit"** ou **"Configurar"**

### 6.3 Preencher Dados

```
Callback URL:
https://seu-app.vercel.app/api/whatsapp/webhook

Verify Token:
meu_token_verificacao_123
(o MESMO que voc√™ escolheu no passo 3.3!)
```

‚ö†Ô∏è **Aten√ß√£o:** URL deve terminar com `/api/whatsapp/webhook`

### 6.4 Verificar

Clique em **"Verify and Save"** ou **"Verificar e Salvar"**

**Deve aparecer:**

```
‚úÖ Webhook verified successfully!
```

Se der erro:

- Verify Token est√° diferente do `.env`
- URL est√° errada
- Deploy n√£o terminou

### 6.5 Subscribe aos Eventos

Ainda na p√°gina Configuration:

1. Procure: **"Webhook fields"**
2. Marque: ‚òëÔ∏è **"messages"**
3. Clique em **"Subscribe"**

‚úÖ Webhook configurado!

---

## üì± Passo 7: Adicionar Seu N√∫mero (2 min)

### 7.1 Voltar para API Setup

Menu lateral > **"API Setup"**

### 7.2 Adicionar N√∫mero de Teste

Procure: **"To"** (Para)

Clique em **"Manage phone number list"**

### 7.3 Adicionar Seu WhatsApp

Digite seu n√∫mero:

```
+55 11 99999-9999
```

Formato: `+[pa√≠s] [DDD] [n√∫mero]`

Clique em **"Send Code"**

### 7.4 Confirmar C√≥digo

1. Abra o WhatsApp no celular
2. Voc√™ receber√° uma mensagem com c√≥digo
3. Digite o c√≥digo na tela do Meta
4. Clique em **"Verify"**

‚úÖ Seu n√∫mero autorizado!

---

## üß™ Passo 8: TESTAR! (2 min)

### 8.1 Encontrar N√∫mero de Teste

Na p√°gina **API Setup**, veja:

```
From: +1 555 0100
(ou outro n√∫mero)
```

Este √© o n√∫mero do bot!

### 8.2 Enviar Mensagem

1. Abra WhatsApp
2. Adicione o n√∫mero de teste
3. Envie: **"Ol√°"**

### 8.3 Ver Resposta da IA

A IA deve responder algo como:

```
Ol√°! Bem-vindo ao nosso consult√≥rio odontol√≥gico.
Como posso ajud√°-lo?
```

‚úÖ **FUNCIONOU!** üéâ

---

## üí¨ Passo 9: Testar Agendamento (3 min)

### Conversa√ß√£o Completa:

```
Voc√™: Quero agendar uma consulta

IA: Claro! Vou te ajudar com isso.
    Qual √© o seu nome completo?

Voc√™: Jo√£o Silva

IA: Prazer, Jo√£o! Qual tipo de servi√ßo voc√™ precisa?
    Temos limpeza, canal, extra√ß√£o, avalia√ß√£o...

Voc√™: Limpeza

IA: Perfeito! Para qual data voc√™ gostaria de agendar?

Voc√™: Amanh√£

IA: E qual hor√°rio prefere?
    Atendemos de segunda a sexta, das 8h √†s 18h.

Voc√™: 14h

IA: ‚úÖ Agendamento confirmado!

    üìã Resumo:
    Nome: Jo√£o Silva
    Servi√ßo: Limpeza
    Data: 11/10/2025
    Hor√°rio: 14:00

    Nos vemos em breve! üòä
```

### Verificar no Painel

1. Abra: `https://seu-app.vercel.app`
2. Fa√ßa login
3. V√° em **"Agenda"**
4. Deve aparecer o agendamento do Jo√£o Silva!

‚úÖ Agendamento criado automaticamente!

---

## üîÑ Passo 10: Gerar Token Permanente (10 min)

O token tempor√°rio expira em 24h. Para produ√ß√£o, gere um permanente:

### 10.1 Acessar Business Settings

1. No Meta for Developers
2. Procure **"Business Settings"** (menu superior)
3. Ou acesse: https://business.facebook.com/settings

### 10.2 Criar System User

1. Menu lateral: **"System Users"** (Usu√°rios do Sistema)
2. Clique em **"Add"** (Adicionar)
3. Nome: **"WhatsApp Bot"**
4. Role: **"Admin"**
5. Clique em **"Create System User"**

### 10.3 Gerar Token

1. Clique no System User criado ("WhatsApp Bot")
2. Clique em **"Generate New Token"**
3. Selecione seu app: **"Cl√≠nica Speodonto"**
4. Marque permiss√µes:
   - ‚òëÔ∏è `whatsapp_business_messaging`
   - ‚òëÔ∏è `whatsapp_business_management`
5. Clique em **"Generate Token"**

### 10.4 Copiar Token Permanente

‚ö†Ô∏è **IMPORTANTE:** Copie AGORA! N√£o vai aparecer de novo!

```
EAAxxxxxxxxxxxxxxxxxxxx...
```

1. Copie e salve em lugar MUITO seguro
2. Este token vale por 60 dias

### 10.5 Atualizar no Projeto

**.env local:**

```env
WHATSAPP_API_TOKEN="novo_token_permanente"
```

**Vercel:**

```bash
vercel env rm WHATSAPP_API_TOKEN
vercel env add WHATSAPP_API_TOKEN
# Cole o novo token

vercel --prod
```

‚úÖ Token permanente configurado!

---

## üéØ Como Funciona (Explica√ß√£o T√©cnica)

### Fluxo Completo:

```
1. Cliente envia mensagem
   ‚Üì
2. WhatsApp Cloud API recebe
   ‚Üì
3. Meta envia para seu webhook
   POST /api/whatsapp/webhook
   ‚Üì
4. Seu backend recebe
   ‚Üì
5. Busca conversa no banco (ou cria nova)
   ‚Üì
6. Monta hist√≥rico de mensagens
   ‚Üì
7. Envia para Gemini AI
   ‚Üì
8. Gemini analisa e responde
   ‚Üì
9. Backend salva resposta no banco
   ‚Üì
10. Verifica se agendamento est√° completo
   ‚Üì
11a. Se SIM: cria no banco
   ‚Üì
11b. Se N√ÉO: continua coletando dados
   ‚Üì
12. Envia resposta via WhatsApp API
   ‚Üì
13. Cliente recebe mensagem
```

### Arquivo Principal:

`app/api/whatsapp/webhook/route.ts`

**Fun√ß√µes:**

- `GET` - Verifica webhook (Meta faz isso)
- `POST` - Recebe mensagens e processa

**Integra:**

- Prisma (banco)
- Gemini (IA)
- WhatsApp API (envio)

---

## ‚úÖ Checklist WhatsApp

- [ ] App criado no Meta
- [ ] WhatsApp adicionado
- [ ] Access Token copiado
- [ ] Phone Number ID copiado
- [ ] Verify Token escolhido
- [ ] Vari√°veis no `.env`
- [ ] Deploy Vercel atualizado
- [ ] Webhook configurado ‚úÖ
- [ ] Campo "messages" subscrito ‚úÖ
- [ ] Meu n√∫mero adicionado e confirmado
- [ ] Enviei "Ol√°" e recebi resposta
- [ ] Testei agendamento completo
- [ ] Agendamento apareceu no painel
- [ ] (Opcional) Token permanente gerado

---

## üêõ Problemas Comuns

### ‚ùå "Webhook verification failed"

**Causa:** Verify Token diferente

**Solu√ß√£o:**

1. Verifique o `WHATSAPP_VERIFY_TOKEN` no `.env`
2. Deve ser EXATAMENTE igual ao que voc√™ digitou no Meta
3. Sem espa√ßos, case-sensitive
4. Fa√ßa novo deploy: `vercel --prod`

---

### ‚ùå Bot n√£o responde

**Poss√≠veis causas:**

**1. N√∫mero n√£o est√° na lista de teste**

Solu√ß√£o:

- API Setup > To > Adicionar n√∫mero
- Confirmar c√≥digo

**2. Campo "messages" n√£o subscrito**

Solu√ß√£o:

- Configuration > Webhook fields
- Marcar "messages" ‚úÖ

**3. Deploy n√£o terminou**

Solu√ß√£o:

- Aguarde o deploy terminar
- Verifique em: https://vercel.com/dashboard

**4. Gemini sem cr√©ditos/erro**

Solu√ß√£o:

- Verifique: https://makersuite.google.com/app/apikey
- Gere nova chave se necess√°rio

---

### ‚ùå "Token expired"

**Causa:** Token tempor√°rio expirou (24h)

**Solu√ß√£o:**

1. Gere token permanente (Passo 10)
2. OU copie novo token tempor√°rio
3. Atualize na Vercel
4. Novo deploy

---

### ‚ùå Mensagem n√£o envia

**Causa:** Token inv√°lido ou expirado

**Solu√ß√£o:**

1. Verifique o token no Meta
2. Gere novo se necess√°rio
3. Atualize `.env` e Vercel

---

## üé® Personalizar Prompt da IA

### Editar Comportamento do Bot

Arquivo: `lib/ai-service-gemini.ts`

Linha ~16:

```typescript
private buildSystemPrompt(context?: ConversationContext): string {
  const basePrompt = `Voc√™ √© um assistente virtual...`
```

**Personaliza√ß√µes:**

**1. Mudar hor√°rios:**

```typescript
3. Hor√°rios dispon√≠veis: Segunda a S√°bado, 9h √†s 19h
```

**2. Adicionar servi√ßos:**

```typescript
- Servi√ßo desejado (limpeza, canal, extra√ß√£o, avalia√ß√£o,
  clareamento, aparelho, implante, pr√≥tese)
```

**3. Mudar tom:**

```typescript
1. Seja super amig√°vel e use emojis üòä
```

**4. Adicionar informa√ß√µes:**

```typescript
8. Nosso endere√ßo: Rua ABC, 123 - Centro
9. Aceitamos conv√™nios: Unimed, Bradesco
```

### Aplicar Mudan√ßas

```bash
# Commit
git add lib/ai-service-gemini.ts
git commit -m "feat: personalizar prompt da IA"

# Deploy
vercel --prod
```

---

## üí∞ Custos (Resumo)

| Servi√ßo          | Custo | Limite               |
| ---------------- | ----- | -------------------- |
| **WhatsApp API** | $0    | 1000 conversas/m√™s\* |
| **Gemini AI**    | $0    | 60 req/min           |
| **Vercel**       | $0    | 100GB/m√™s            |
| **PostgreSQL**   | $0    | 0.5GB                |

**Total: $0/m√™s** ‚ú®

\* Mensagens de **resposta** s√£o ILIMITADAS!
S√≥ mensagens iniciadas pelo bot contam no limite.

---

## üöÄ Usar em Produ√ß√£o (Clientes Reais)

### Requisitos:

1. **Verificar Neg√≥cio**

   - Enviar CNPJ/documentos
   - Aprova√ß√£o leva 1-3 dias

2. **Adicionar N√∫mero Real**

   - Comprar n√∫mero novo OU
   - Migrar n√∫mero existente

3. **Solicitar Produ√ß√£o**
   - Preencher formul√°rio de uso
   - Aguardar aprova√ß√£o

### Limites Produ√ß√£o:

- Come√ßa: 250 conversas/dia
- Aumenta automaticamente com uso
- At√© 100.000/dia (para neg√≥cios grandes)

---

## üéØ Resumo

Voc√™ configurou:

‚úÖ WhatsApp Business Cloud API (gr√°tis)
‚úÖ Gemini AI para conversa√ß√£o (gr√°tis)
‚úÖ Webhook funcionando
‚úÖ Agendamento autom√°tico
‚úÖ Confirma√ß√£o via WhatsApp

**Custo: $0/m√™s** üí∞

**Sistema 100% funcional!** üéâ

---

## üìö Pr√≥ximos Passos

1. ‚úÖ Personalize o prompt da IA
2. ‚úÖ Teste com amigos/fam√≠lia
3. ‚úÖ Ajuste conforme necess√°rio
4. ‚úÖ Quando estiver satisfeito, verifique seu neg√≥cio no Meta
5. ‚úÖ Adicione n√∫mero real
6. ‚úÖ Comece a usar com clientes!

**Parab√©ns! Seu sistema est√° completo e funcionando! üöÄ**
